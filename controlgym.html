<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ControlGym - Calendario</title>
<style>
  /* ESTILOS GENERALES Y CONTENEDORES */
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a1d; color: #f1f1f1; margin: 0; padding: 0; }
  .header-container { background: #2c2f33; padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  #user-header { max-width: 600px; margin: 0 auto; background: transparent; }
  .main-container { max-width: 600px; margin: 25px auto; background: #2c2f33; padding: 20px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
  h1 { color: #0095ff; border-bottom: 2px solid #4f545c; padding-bottom: 10px; margin-top: 0; text-align: center; }
  /* FIN DE ESTILOS GENERALES */

  #controles { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 15px; flex-wrap: wrap; }
  select { padding: 8px; border-radius: 8px; border: 1px solid #4f545c; background: #25272a; color: white; }
  button {
    padding: 8px;
    border-radius: 8px;
    background: linear-gradient(45deg, #050a19, #002244);
    color: white;
    border: 1px solid #004466;
  }
  #calendario { width: 95%; max-width: 800px; margin: auto; }
  table { width: 100%; border-collapse: collapse; table-layout: fixed; }
  th, td { border: 1px solid #4f545c; padding: 5px; text-align: center; height: 80px; vertical-align: top; position: relative; }  
  th { background: #007bff; color: white; height: auto; padding: 10px; border: none; }
  td { background: #33363a; }
  td button { width: 30px; height: 30px; border-radius: 50%; border: none; background: #4f545c; color: white; cursor: pointer; font-weight: bold; transition: background 0.2s; }
  td button:hover { background: #007bff; }
  td button.hoy { background: #ffc107; color: black; border: 2px solid #e0a800; }
  .check { position: absolute; top: 5px; right: 5px; color: green; font-size: 1.2em; }
  .check-calendario {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    color: limegreen;
    font-size: 24px;
    font-weight: bold;
    text-shadow: 0 0 5px black;
    pointer-events: none; /* Para que no interfiera con el clic */
  }
  td[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #111;
    color: white;
    padding: 5px;
    border-radius: 8px;
    z-index: 10;
    font-size: 0.8em;
    white-space: pre-wrap;
    width: max-content;
    max-width: 200px;
  }
  .botones-footer { display: flex; justify-content: center; gap: 20px; margin: 20px; }
  .boton-stats {
    background: linear-gradient(45deg, #050a19, #002244);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    transition: opacity 0.3s;
    border: 1px solid #004466;
  }
  .boton-stats:hover { opacity: 0.9; }  
  #user-header { background: #343a40; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
  #user-greeting { font-weight: bold; }
  #logout-btn { background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; transition: opacity 0.3s; }
  #logout-btn:hover { opacity: 0.8; }
  footer { text-align: center; padding: 15px; background: #2c2f33; color: #aaa; margin-top: 20px; }
</style>
</head>
<body>

<div class="header-container">
  <div id="user-header">
    <span id="user-greeting"></span>
    <button id="logout-btn">Cerrar SesiÃ³n</button>
  </div>
</div>

<div class="main-container">
  <h1>ðŸ“… Calendario de Entrenamiento</h1>
  <div id="controles">
    <select id="mes"></select>
    <select id="anio"></select>
  </div>
  <div id="calendario">
    <div id="calendarioTabla"></div>
  </div>
  <div class="botones-footer">
    <a href="estadisticas.html" class="boton-stats">ðŸ“Š Ver EstadÃ­sticas</a>
  </div>
</div>

<footer>
  &copy;
 DasanloSoft, 2025
</footer>

<!-- Scripts de datos de rutinas y videos con 'defer' -->
<script src="rutinas.js" defer></script>
<script src="videos.js" defer></script>

<script type="module">
    import { db, auth } from './firebase-config.js';
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const greeting = document.getElementById('user-greeting');
        if (greeting) {
          greeting.textContent = `Hola, ${user.displayName || user.email}`;
        }
        document.getElementById('logout-btn').addEventListener('click', () => {
          signOut(auth).then(() => window.location.href = 'index.html');
        });
        initializeApp(user); // Pasamos el objeto user completo
      } else {
        window.location.href = 'index.html';
      }
    });

    async function initializeApp(user) {
    (async function() { // IIFE asÃ­ncrona - INICIO
  const userId = user.uid;
  const meses = [
  "Enero","Febrero","Marzo","Abril","Mayo","Junio",
  "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];
const diasSemana = ["L", "M", "X", "J", "V", "S", "D"];
const hoy = new Date();
const mesActual = hoy.getMonth();
const aÃ±oActual = hoy.getFullYear();

const selectMes = document.getElementById('mes');
const selectAnio = document.getElementById('anio');
const calendarioTabla = document.getElementById('calendarioTabla');

// Rellenar meses
meses.forEach((m, i) => {
  const opt = document.createElement('option');
  opt.value = i;
  opt.textContent = m;
  if (i === mesActual) opt.selected = true;
  selectMes.appendChild(opt);
});

// Rellenar aÃ±os (rango 2020â€“2030)
for (let y = 2020; y <= 2030; y++) {
  const opt = document.createElement('option');
  opt.value = y;
  opt.textContent = y;
  if (y === aÃ±oActual) opt.selected = true;
  selectAnio.appendChild(opt);
}

selectMes.addEventListener('change', () => {
  renderCalendario(parseInt(selectMes.value), parseInt(selectAnio.value), user.uid);
});
selectAnio.addEventListener('change', () => {
  renderCalendario(parseInt(selectMes.value), parseInt(selectAnio.value), user.uid);
});

await renderCalendario(mesActual, aÃ±oActual, userId);
    })(); // IIFE asÃ­ncrona - FIN Y EJECUCIÃ“N
  }

  // La funciÃ³n renderCalendario se mueve fuera de initializeApp para que sea accesible por los event listeners
  async function renderCalendario(mes, anio, userId) {
  const hoy = new Date();
  const mesActual = hoy.getMonth();
  const aÃ±oActual = hoy.getFullYear();
  const diasSemana = ["L", "M", "X", "J", "V", "S", "D"];
  const calendarioTabla = document.getElementById('calendarioTabla');

  calendarioTabla.innerHTML = '';
  const fecha = new Date(anio, mes, 1);
  const diasEnMes = new Date(anio, mes + 1, 0).getDate();
  const primerDiaSemana = (fecha.getDay() + 6) % 7;

  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trHead = document.createElement('tr');
  diasSemana.forEach(dia => {
    const th = document.createElement('th');
    th.textContent = dia;
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  let tr = document.createElement('tr');
  for (let i = 0; i < primerDiaSemana; i++) {
    tr.appendChild(document.createElement('td'));
  }

  for (let d = 1; d <= diasEnMes; d++) {
    const hoyStr = `${aÃ±oActual}-${String(mesActual+1).padStart(2,'0')}-${String(hoy.getDate()).padStart(2,'0')}`;
    const td = document.createElement('td');
    const fechaStr = `${anio}-${String(mes+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

    const btn = document.createElement('button');
    btn.dataset.fecha = fechaStr; // AÃ±adimos un data-attribute para identificar el botÃ³n
    btn.textContent = d;
    btn.onclick = () => {
      window.location.href = `rutinas.html?fecha=${fechaStr}`;
    };

    if (fechaStr === hoyStr) {
      btn.classList.add('hoy');
    }

    td.appendChild(btn);
    tr.appendChild(td);
    if ((primerDiaSemana + d) % 7 === 0) {
      tbody.appendChild(tr);
      tr = document.createElement('tr');
    }
  }

  tbody.appendChild(tr);
  table.appendChild(tbody);
  calendarioTabla.appendChild(table);

  // Ahora, cargamos los datos y aÃ±adimos los checks y tooltips
  const querySnapshot = await getDocs(collection(db, "users", userId, "registros"));
  const data = {};
  querySnapshot.forEach(doc => { data[doc.id] = doc.data(); });

  Object.keys(data).forEach(fechaConDatos => {
    const celda = table.querySelector(`button[data-fecha="${fechaConDatos}"]`)?.parentElement; // Buscamos por el data-attribute
    if (celda) {
      const resumen = Object.entries(data[fechaConDatos])
        .map(([_, ejercicios]) => Object.keys(ejercicios).filter(e => Array.isArray(ejercicios[e]) && ejercicios[e].length > 0))
        .flat()
        .join(', ');

      if (resumen) {
        celda.setAttribute('data-tooltip', resumen);
        const check = document.createElement('div');
        check.className = 'check-calendario';
        check.textContent = 'âœ“';
        celda.appendChild(check);
      }
    }
  });
}

</script>
</body>
</html>
