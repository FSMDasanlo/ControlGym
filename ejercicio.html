<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ejercicio</title>
<style>
body { font-family: Arial; background:#f4f4f4; margin:0; padding:0;}
h1 { text-align:center; color:#007bff; padding:10px;}
#fecha, #tituloRutina, #tituloEjercicio { text-align:center; font-weight:bold; margin-bottom:10px;}
#tituloEjercicio { font-size:1.2em; font-style: italic; color: #004d4d; }

#videoEjercicio { text-align: center; margin-bottom: 15px; }
#videoEjercicio iframe { width: 90%; max-width: 500px; height: 280px; border-radius: 8px; }
#videoEjercicio a { display: inline-block; background: #17a2b8; color: white; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-weight: bold; }
#videoEjercicio a:hover { background: #117a8b; }

table { width:95%; max-width:600px; margin:auto; border-collapse:collapse; margin-top:15px; font-size: 0.9em; table-layout: fixed; word-wrap: break-word; background:white;}
th, td { border:1px solid #ccc; padding:4px 6px; text-align:center; height:28px; }
th { background:#007bff; color:white; font-weight:bold; padding:6px 4px; }
tfoot td { background: #e9ecef; font-weight: bold; }

th:nth-child(1), td:nth-child(1) { width: 35%; }
th:nth-child(2), td:nth-child(2) { width: 25%; }
th:nth-child(3), td:nth-child(3) { width: 25%; }
th:nth-child(4), td:nth-child(4) { width: 15%; }

.boton-accion { background:#dc3545; color:white; border:none; border-radius:4px; padding:4px 6px; cursor:pointer; margin-left:4px; }
.boton-accion.edit { background:#ffc107; color:black; }
.boton-accion:hover { opacity:0.8; }

#formulario { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin:15px;}
input { padding:5px; width:120px; }
button { background:#28a745; color:white; padding:5px 10px; border:none; border-radius:5px; cursor:pointer;}
button:hover { background:#218838;}

#toast { visibility:hidden; min-width:200px; background:#333; color:#fff; text-align:center; border-radius:8px; padding:10px; position:fixed; z-index:1; left:50%; bottom:30px; transform:translateX(-50%); font-size:0.9em;}
#toast.show { visibility:visible; animation: fadein 0.3s, fadeout 0.3s 1.7s; }
@keyframes fadein { from {bottom:0;opacity:0;} to {bottom:30px;opacity:1;} }
@keyframes fadeout { from {bottom:30px;opacity:1;} to {bottom:0;opacity:0;} }

.boton-volver { display: block; width: 90%; max-width: 500px; margin: 10px auto; padding: 12px; font-size: 1.1em; font-weight: bold; text-align: center; border-radius: 10px; text-decoration: none; transition: background 0.3s; }
.boton-volver.rutinas { background: linear-gradient(45deg, #6c757d, #5a6268); color: white; }
.boton-volver.ejercicios { background: linear-gradient(45deg, #28a745, #218838); color: white; }
.boton-volver:hover { opacity: 0.9; }
.boton-volver i { margin-right: 8px; }

#grafica-container {
  width:95%;
  max-width:600px;
  margin:25px auto;
  background:white;
  padding:10px;
  border-radius:8px;
  box-shadow:0 0 5px rgba(0,0,0,0.1);
  text-align:center;
}
#grafica-container button { margin-bottom:10px; }

@media (max-width: 480px) {
  table { font-size: 0.8em; }
  th, td { padding:3px 4px; }
  button.boton-eliminar { padding:2px 5px; font-size:0.75em; }
}
.btn-filtro { background: #17a2b8; color: white; padding:6px 12px; border: none; border-radius:6px; cursor:pointer; font-size:0.9em; font-weight:bold; transition: background 0.3s; }
.btn-filtro:hover { background:#117a8b; }

td.max-valor {
  background: #ffc107; /* amarillo brillante */
  color: black;
  font-weight: bold;
}
#user-header { background: #343a40; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
#user-greeting { font-weight: bold; }
#logout-btn { background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
#logout-btn:hover { background: #c82333; }
</style>
</head>
<body>

<div id="user-header">
  <span id="user-greeting"></span>
  <button id="logout-btn">Cerrar Sesi√≥n</button>
</div>

<h1 id="tituloPrincipal">Ejercicio</h1>
<div id="fecha"></div>
<div id="tituloEjercicio"></div>
<div id="videoEjercicio"></div>

<table>
  <thead id="thead"></thead>
  <tbody id="tbody"></tbody>
  <tfoot id="tfoot"></tfoot>
</table>

<!-- Gr√°fica con bot√≥n -->
<div id="grafica-container">
  <button id="toggleVista" class="btn-filtro" onclick="alternarVista()">üìà Hist√≥rico</button>
  <canvas id="graficaProgreso" style="margin-top:10px;"></canvas>
</div>

<div id="formulario">
  <input type="number" id="peso" placeholder="Peso (kg)">
  <input type="number" id="reps" placeholder="Repeticiones">
  <button onclick="guardarDatos()">Guardar</button>
</div>

<a id="volverEjercicios" class="boton-volver ejercicios" href="#"><i>‚Ü©Ô∏è</i> Volver a Ejercicios</a>
<a id="volverRutinas" class="boton-volver rutinas" href="#"><i>üè†</i> Volver a Rutinas</a>

<div id="toast">‚úÖ Datos guardados</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 

<script type="module">
  import { db, auth } from './firebase-config.js';
  import { doc, getDoc, setDoc, getDocs, collection, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";

  let userId = null;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      userId = user.uid;
      const greeting = document.getElementById('user-greeting');
      if (greeting) {
        greeting.textContent = `Hola, ${user.displayName || user.email}`;
      }
      document.getElementById('logout-btn').addEventListener('click', () => {
        signOut(auth).then(() => window.location.href = 'index.html');
      });
      initializeApp();
    } else {
      window.location.href = 'index.html';
    }
  });
async function initializeApp() {
(async function() { // IIFE as√≠ncrona
const rutinas = [
  {titulo:"Pecho, b√≠ceps y abdominales", ejercicios:["Press de banca con barra","Aperturas en banco inclinado con mancuernas","Press inclinado con mancuernas","Curl de b√≠ceps con barra","Crunch en m√°quina con carga alta"]},
  {titulo:"Espalda y tr√≠ceps", ejercicios:["Dominadas en barra fija","Remo con barra","Press franc√©s","Extensiones de tr√≠ceps en polea alta","Fondos de tr√≠ceps"]},
  {titulo:"Hombros, trapecio y piernas", ejercicios:["Elevaciones laterales con mancuernas","Trapecios con polea baja","Sentadillas con barra","Extensiones de piernas","Peso muerto con barra","Gemelo en m√°quina"]},
  {titulo:"Pecho y b√≠ceps", ejercicios:["Press de banca con mancuernas","Press declinado con mancuernas","Curl de b√≠ceps sentado con mancuerna","Curl de b√≠ceps"]},
  {titulo:"Espalda y tr√≠ceps 2", ejercicios:["Remo en polea baja","Peso muerto","Extensi√≥n vertical alterna con mancuerna","Flexiones de tr√≠ceps"]},
  {titulo:"Rodillas", ejercicios:["Sentadillas de bajo impacto","Elevaci√≥n de piernas","Ejercicios isom√©tricos"]}
];

// reemplaza: const videos = {};
const videos = {
  0: [
    "https://www.youtube.com/watch?v=fqsTgdTPRQU",
    "https://www.youtube.com/watch?v=fHmiVMFfKkE",
    "https://www.youtube.com/shorts/a64mtMHyPfY",
    "https://www.youtube.com/watch?v=IKxDIDNV890",
    "https://www.youtube.com/watch?v=_m9lZOfi_W0",
  ],
  1: [
    "https://www.youtube.com/watch?v=XZ9TKvUz-ZE",
    "https://www.youtube.com/watch?v=MwCJGBu8PFk",
    "https://www.youtube.com/shorts/BTkLgHG7kzo",
    "https://www.youtube.com/watch?v=cGEPFQ99pyQ",
    "https://www.youtube.com/watch?v=H6r0fh2-YNU",
  ],
  2: [
    "https://www.youtube.com/watch?v=OCoQIC9ojAA",
    "https://www.youtube.com/watch?v=cTRcA2sJqeM",
    "https://www.youtube.com/watch?v=dsCuiccYNGs",
    "https://www.youtube.com/watch?v=J-Y-Z0EU9Ic",
    "https://www.youtube.com/watch?v=0XL4cZR2Ink",
    "https://www.youtube.com/watch?v=Mr4W1DCj05U",
  ],
  3: [
    "https://www.youtube.com/watch?v=jrDDz7x1Dpo",
    "https://www.youtube.com/watch?v=2uWdrii0ZG8",
    "https://www.youtube.com/watch?v=96O5mvyblQM",
    "https://www.youtube.com/watch?v=HU2lghjU29Y",
  ],
  4: [
    "https://www.youtube.com/shorts/evFO5upohaY",
    "https://www.youtube.com/watch?v=0XL4cZR2Ink",
    "https://www.youtube.com/watch?v=rAUjieI_UVk",
    "https://www.youtube.com/watch?v=szc48Qhec8Q",
  ],
  5: [
    "https://www.youtube.com/watch?v=7E_Lks-oZT4",
    "https://www.youtube.com/watch?v=eEbq5_AIgpo",
    "https://www.youtube.com/watch?v=DOPV51VQNac",
  ]
};

const params = new URLSearchParams(window.location.search);
const fecha = params.get('fecha');
const rutinaIndex = parseInt(params.get('rutina'));
const ejercicioIndex = parseInt(params.get('ejercicio'));

const rutina = rutinas[rutinaIndex];

const docRefCustomEjercicios = doc(db, "users", userId, "personalizados", "ejercicios");
const docSnapCustomEjercicios = await getDoc(docRefCustomEjercicios);
const customExercises = docSnapCustomEjercicios.exists() ? docSnapCustomEjercicios.data() : {};
const customVideos = {}; // A√∫n no se usa, pero si se usara, tambi√©n necesitar√≠a el userId

const personalizados = customExercises[rutinaIndex] || [];
const todosEjercicios = [...rutina.ejercicios, ...personalizados];
const todosVideos = [
  ...(videos[rutinaIndex] || []),
  ...(customVideos[rutinaIndex] || [])
];

const ejercicioNombre = todosEjercicios[ejercicioIndex];
const videoUrl = todosVideos[ejercicioIndex] || null;

document.getElementById('fecha').textContent = fecha.split('-').reverse().join('-');
document.getElementById('tituloPrincipal').textContent = rutina.titulo;
document.getElementById('tituloEjercicio').textContent = ejercicioNombre;
document.getElementById('volverEjercicios').href = `ejercicios.html?fecha=${fecha}&rutina=${rutinaIndex}`;
document.getElementById('volverRutinas').href = `rutinas.html?fecha=${fecha}`;

if (videoUrl) {
  let embedHtml = '';
  if (videoUrl.includes('youtube.com/watch')) {
    const videoId = new URL(videoUrl).searchParams.get('v');
    embedHtml = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
  } else if (videoUrl.includes('youtube.com/shorts/')) {
    const videoId = videoUrl.split('/shorts/')[1];
    embedHtml = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
  } else {
    embedHtml = `<a href="${videoUrl}" target="_blank">‚ñ∂ Ver v√≠deo del ejercicio</a>`;
  }
  document.getElementById('videoEjercicio').innerHTML = embedHtml;
}

const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const tfoot = document.getElementById('tfoot');

thead.innerHTML = `<tr><th>Fecha</th><th>Peso (kg)</th><th>Repeticiones</th><th>Acciones</th></tr>`;

// Construimos registros desde Firestore
let registros = [];
const querySnapshot = await getDocs(collection(db, "users", userId, "registros"));
const data = {};
querySnapshot.forEach(doc => {
    data[doc.id] = doc.data();
});
for (const f in data) { // f es la fecha (ID del documento)
  const ejer = data[f]?.[rutinaIndex]?.[ejercicioNombre];
  if (Array.isArray(ejer)) {
    ejer.forEach((r, i) => registros.push({ fecha: f, peso: r.peso, reps: r.reps, index: i }));
  }
}
registros.sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));

// Funci√≥n para generar la tabla
function actualizarTabla() {
  if (!registros.length) {
    tbody.innerHTML = `<tr><td colspan="4">No hay datos guardados a√∫n</td></tr>`;
    tfoot.innerHTML = '';
  } else {
  // Calcular m√°ximos
const maxPeso = Math.max(...registros.map(r => r.peso));
const maxReps = Math.max(...registros.map(r => r.reps));

// Pintar filas
tbody.innerHTML = registros.map((r, i) => `
  <tr data-fecha="${r.fecha}" data-idx="${r.index}">
    <td contenteditable="true" class="edit-fecha">${r.fecha.split('-').reverse().join('-')}</td>
    <td contenteditable="true" class="edit-peso ${r.peso === maxPeso ? 'max-valor' : ''}">${r.peso}</td>
    <td contenteditable="true" class="edit-reps ${r.reps === maxReps ? 'max-valor' : ''}">${r.reps}</td>
    <td>
      <button class="boton-accion edit" onclick="editarFila(this)">üíæ</button>
      <button class="boton-accion" onclick="eliminarFila('${r.fecha}', ${r.index})">üóëÔ∏è</button>
    </td>
  </tr>
`).join('');

    actualizarResumen();
  }
}

// Funci√≥n para resumen
function actualizarResumen(){
  if (!registros.length) return;
  const dias = registros.length;
  const mediaPeso = (registros.reduce((a,b)=>a+b.peso,0)/dias).toFixed(2);
  const mediaReps = (registros.reduce((a,b)=>a+b.reps,0)/dias).toFixed(2);
  tfoot.innerHTML = `<tr><td>${dias} d√≠as</td><td>${mediaPeso}</td><td>${mediaReps}</td><td></td></tr>`;
}

// Inicializamos tabla
actualizarTabla();

// Funciones para guardar, editar y eliminar
async function guardarDatos(){
  const peso = parseFloat(document.getElementById('peso').value) || 0;
  const reps = parseInt(document.getElementById('reps').value) || 0;

  const docRef = doc(db, "users", userId, "registros", fecha);
  const docSnap = await getDoc(docRef);

  if (docSnap.exists()) {
    const datosActuales = docSnap.data();
    const registrosEjercicio = datosActuales[rutinaIndex]?.[ejercicioNombre] || [];
    registrosEjercicio.push({ peso, reps });
    await updateDoc(docRef, {
      [`${rutinaIndex}.${ejercicioNombre}`]: registrosEjercicio
    });
  } else {
    const nuevoDato = {
      [rutinaIndex]: {
        [ejercicioNombre]: [{ peso, reps }]
      }
    };
    await setDoc(docRef, nuevoDato);
  }

  mostrarToast("‚úÖ Datos guardados");
  setTimeout(()=> location.reload(),500);
}

async function eliminarFila(f, idx){
  if (!confirm("¬øEliminar este registro?")) return;
  const docRef = doc(db, "users", userId, "registros", f);
  const docSnap = await getDoc(docRef);
  if (!docSnap.exists()) return;

  const datosActuales = docSnap.data();
  const registrosEjercicio = datosActuales[rutinaIndex]?.[ejercicioNombre] || [];
  registrosEjercicio.splice(idx, 1);

  if (registrosEjercicio.length === 0) {
    await updateDoc(docRef, { [`${rutinaIndex}.${ejercicioNombre}`]: deleteField() });
  } else {
    await updateDoc(docRef, { [`${rutinaIndex}.${ejercicioNombre}`]: registrosEjercicio });
  }
  location.reload();
}

async function editarFila(btn){
  const fila = btn.closest('tr');
  const fOriginal = fila.dataset.fecha;
  const idx = parseInt(fila.dataset.idx);
  const nuevaFecha = fila.querySelector('.edit-fecha').textContent.split('-').reverse().join('-');
  const nuevoPeso = parseFloat(fila.querySelector('.edit-peso').textContent);
  const nuevasReps = parseInt(fila.querySelector('.edit-reps').textContent);

  // Elimina el registro antiguo
  await eliminarFila(fOriginal, idx);

  // Guarda el nuevo registro (simulando un guardado normal)
  const docRef = doc(db, "users", userId, "registros", nuevaFecha);
  const docSnap = await getDoc(docRef);
  const datosNuevos = docSnap.exists() ? docSnap.data() : {};
  if (!datosNuevos[rutinaIndex]) datosNuevos[rutinaIndex] = {};
  if (!datosNuevos[rutinaIndex][ejercicioNombre]) datosNuevos[rutinaIndex][ejercicioNombre] = [];
  datosNuevos[rutinaIndex][ejercicioNombre].push({ peso: nuevoPeso, reps: nuevasReps });

  if (docSnap.exists()) {
    await updateDoc(docRef, datosNuevos);
  } else {
    await setDoc(docRef, datosNuevos);
  }

  mostrarToast("üíæ Cambios guardados");
  setTimeout(()=> location.reload(),500);
}

function mostrarToast(text){
  const toast = document.getElementById("toast");
  toast.textContent = text;
  toast.className = "show";
  setTimeout(()=> toast.className = toast.className.replace("show",""),2000);
}

// Exponer funciones al scope global para los onclick
window.guardarDatos = guardarDatos;
window.eliminarFila = eliminarFila;
window.editarFila = editarFila;

// ===================== Gr√°fica =====================
let vistaActual = '2m';
let grafica = null;

function alternarVista() {
  vistaActual = vistaActual === '2m' ? 'all' : '2m';
  document.getElementById('toggleVista').textContent = 
    vistaActual === '2m' ? 'üìà Hist√≥rico' : 'üìÖ Dos √∫ltimos meses';
  generarGrafica();
}
window.alternarVista = alternarVista; // Hacemos la funci√≥n accesible globalmente

function generarGrafica() {
  const ctx = document.getElementById('graficaProgreso');
  if (!ctx || !registros.length) return;

  let registrosFiltrados = [...registros];
  if (vistaActual === '2m') {
    const haceDosMeses = new Date();
    haceDosMeses.setMonth(haceDosMeses.getMonth() - 2);
    registrosFiltrados = registros.filter(r => new Date(r.fecha) >= haceDosMeses);
  }

  const etiquetas = registrosFiltrados.map(r => r.fecha.split('-').reverse().join('-'));
  const pesos = registrosFiltrados.map(r => r.peso);
  const reps = registrosFiltrados.map(r => r.reps);

  if (grafica) grafica.destroy();

  grafica = new Chart(ctx, {
    type: 'line',
    data: {
      labels: etiquetas,
      datasets: [
        { label: 'Peso (kg)', data: pesos, borderColor: 'blue', tension: 0.2, fill: false },
        { label: 'Repeticiones', data: reps, borderColor: 'orange', tension: 0.2, fill: false }
      ]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
}

// Inicializamos gr√°fica
generarGrafica();
})();
}
</script>

</body>
</html>
