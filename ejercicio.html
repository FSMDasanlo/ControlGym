<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ejercicio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#00c6ff,#0072ff); color:#fff; margin:0; padding:0; text-align:center; }
    h1 { margin:20px 0; font-size:20px; }
    .form-container { background:#fff; color:#000; width:90%; max-width:400px; margin:0 auto; padding:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
    label { display:block; text-align:left; margin:10px 0 5px; font-weight:bold; }
    input { width:100%; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; margin-bottom:10px; }
    .row-btns { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:8px; }
    button { padding:10px 15px; font-size:16px; border:none; border-radius:8px; cursor:pointer; color:#fff; }
    #saveBtn { background:#4caf50; }
    #backExercises { background:#ff9800; }
    #backCalendar { background:#f50057; }
    /* toast */
    #toast { visibility:hidden; min-width:160px; background:#323232; color:#fff; text-align:center; border-radius:6px; padding:10px; position:fixed; z-index:1000; left:50%; bottom:30px; transform:translateX(-50%); font-size:14px; }
    #toast.show { visibility:visible; animation:fadein 0.4s, fadeout 0.4s 1.4s; }
    @keyframes fadein { from {bottom:0; opacity:0;} to {bottom:30px; opacity:1;} }
    @keyframes fadeout { from {bottom:30px; opacity:1;} to {bottom:0; opacity:0;} }
  </style>
</head>
<body>
  <h1 id="fechaTitulo">Ejercicio</h1>

  <div class="form-container">
    <label for="tiempo">Tiempo:</label>
    <input type="text" id="tiempo" placeholder="?">

    <label for="peso">Peso:</label>
    <input type="text" id="peso" placeholder="?">

    <label for="repeticiones">Repeticiones:</label>
    <input type="text" id="repeticiones" placeholder="?">

    <label for="libre">Libre:</label>
    <input type="text" id="libre" placeholder="?">

    <div class="row-btns">
      <button id="saveBtn">üíæ Guardar</button>
      <button id="backExercises">üèãÔ∏è Volver a ejercicios</button>
      <button id="backCalendar">üìÖ Volver al calendario</button>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // Leer par√°metros (acepta 'id' o 'ejercicio' por compatibilidad)
    const params = new URLSearchParams(window.location.search);
    const fecha = params.get('fecha');
    const idxParam = params.get('id') ?? params.get('ejercicio') ?? params.get('numero');
    const ejercicioIndex = idxParam !== null ? parseInt(idxParam, 10) : NaN;

    const tituloEl = document.getElementById('fechaTitulo');
    const tiempoInput = document.getElementById('tiempo');
    const pesoInput = document.getElementById('peso');
    const repeticionesInput = document.getElementById('repeticiones');
    const libreInput = document.getElementById('libre');
    const saveBtn = document.getElementById('saveBtn');
    const backExercises = document.getElementById('backExercises');
    const backCalendar = document.getElementById('backCalendar');
    const toast = document.getElementById('toast');

    function showToast(text, color='#4caf50') {
      toast.textContent = text;
      toast.style.background = color;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 1800);
    }

    // Validaciones b√°sicas
    if (!fecha) {
      tituloEl.textContent = 'Fecha no especificada';
      showToast('Error: falta la fecha', '#d32f2f');
      // desactivar botones de guardado/volver correctamente
      saveBtn.disabled = true;
      backExercises.disabled = true;
      backCalendar.disabled = false;
    } else if (Number.isNaN(ejercicioIndex) || ejercicioIndex < 0) {
      // permitir cero si se env√≠a; pero la UX original usa 0..5 o 1..6 seg√∫n versi√≥n.
      // Aqu√≠ asumimos √≠ndices desde 0 (como us√≥ dia.html con id=idx). Si tu versi√≥n usa 1..6, modifica arriba.
      tituloEl.textContent = `${fecha} - Ejercicio ?`;
      showToast('Error: id de ejercicio inv√°lido', '#d32f2f');
      saveBtn.disabled = true;
    } else {
      // Mostrar t√≠tulo
      // Si el √≠ndice vino en 0..5, mostramos +1 para el usuario
      tituloEl.textContent = `${fecha} - Ejercicio ${ejercicioIndex + 1}`;

      // cargar datos existentes
      const data = JSON.parse(localStorage.getItem('entrenamientos') || '{}');

      // si no existe la fecha, no inicializamos en localStorage todav√≠a; inicializamos en memoria
      if (data[fecha] && data[fecha][ejercicioIndex]) {
        const e = data[fecha][ejercicioIndex];
        tiempoInput.value = e.tiempo ?? '?';
        pesoInput.value = e.peso ?? '?';
        repeticionesInput.value = e.repeticiones ?? '?';
        libreInput.value = e.libre ?? '?';
      } else {
        // valores por defecto
        tiempoInput.value = '?';
        pesoInput.value = '?';
        repeticionesInput.value = '?';
        libreInput.value = '?';
      }

      saveBtn.addEventListener('click', () => {
        const tiempo = (tiempoInput.value || '?').trim() || '?';
        const peso = (pesoInput.value || '?').trim() || '?';
        const repeticiones = (repeticionesInput.value || '?').trim() || '?';
        const libre = (libreInput.value || '?').trim() || '?';

        // cargar de nuevo (por si cambi√≥ en otra pesta√±a)
        const current = JSON.parse(localStorage.getItem('entrenamientos') || '{}');

        // asegurar array de 6 ejercicios
        if (!current[fecha] || !Array.isArray(current[fecha]) || current[fecha].length < 6) {
          current[fecha] = [];
          for (let i = 0; i < 6; i++) {
            current[fecha].push({ ejercicio: `Ejercicio ${i+1}`, tiempo: "?", peso: "?", repeticiones: "?", libre: "?" });
          }
        }

        // guardar en el √≠ndice correcto
        current[fecha][ejercicioIndex] = {
          ejercicio: current[fecha][ejercicioIndex]?.ejercicio ?? `Ejercicio ${ejercicioIndex+1}`,
          tiempo, peso, repeticiones, libre
        };

        // comprobar si hay datos reales en toda la fecha: si NO hay ninguno, eliminamos la fecha
        const tieneAlguno = current[fecha].some(e =>
          (e.tiempo || '').trim() !== '?' && (e.tiempo || '').trim() !== '' ||
          (e.peso || '').trim() !== '?' && (e.peso || '').trim() !== '' ||
          (e.repeticiones || '').trim() !== '?' && (e.repeticiones || '').trim() !== '' ||
          (e.libre || '').trim() !== '?' && (e.libre || '').trim() !== ''
        );

        if (tieneAlguno) {
          localStorage.setItem('entrenamientos', JSON.stringify(current));
          showToast('‚úÖ Datos guardados correctamente');
        } else {
          // si no hay nada guardado (todo '?'), eliminamos la entrada para no generar checks vac√≠os
          delete current[fecha];
          localStorage.setItem('entrenamientos', JSON.stringify(current));
          showToast('‚ö†Ô∏è No se guard√≥ nada (todo vac√≠o)', '#ff9800');
        }
      });
    }

    backExercises.addEventListener('click', () => {
      if (fecha) location.href = `dia.html?fecha=${encodeURIComponent(fecha)}`;
      else location.href = 'index.html';
    });
    backCalendar.addEventListener('click', () => location.href = 'index.html');
  </script>
</body>
</html>
