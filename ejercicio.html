<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ejercicio</title>
<style>
  /* ESTILOS GENERALES Y CONTENEDORES */
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a1d; color: #f1f1f1; margin: 0; padding: 0; }
  .header-container { background: #2c2f33; padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  #user-header { max-width: 600px; margin: 0 auto; background: transparent; }
  .main-container { max-width: 600px; margin: 25px auto; background: #2c2f33; padding: 20px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
  h1 { color: #0095ff; border-bottom: 2px solid #4f545c; padding-bottom: 10px; margin-top: 0; text-align: center; }
  /* FIN DE ESTILOS GENERALES */

#fecha, #tituloRutina, #tituloEjercicio { text-align:center; font-weight:bold; margin-bottom:10px;}
#tituloEjercicio { font-size:1.2em; font-style: italic; color: #004d4d; }

#videoEjercicio { text-align: center; margin-bottom: 15px; }
#videoEjercicio iframe { width: 90%; max-width: 500px; height: 280px; border-radius: 8px; }
#videoEjercicio a { display: inline-block; background: #17a2b8; color: white; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-weight: bold; }
#videoEjercicio a:hover { background: #117a8b; }

table { width:100%; margin:auto; border-collapse:collapse; margin-top:15px; font-size: 0.9em; table-layout: fixed; word-wrap: break-word; }
th, td { border:1px solid #4f545c; padding:8px 6px; text-align:center; }
th { background:#007bff; color:white; font-weight:bold; }
tfoot td { background: #3a3f44; font-weight: bold; }

th:nth-child(1), td:nth-child(1) { width: 35%; }
th:nth-child(2), td:nth-child(2) { width: 25%; }
th:nth-child(3), td:nth-child(3) { width: 25%; }
th:nth-child(4), td:nth-child(4) { width: 15%; }

.boton-accion { background:#dc3545; color:white; border:none; border-radius:4px; padding:4px 6px; cursor:pointer; margin-left:4px; }
.boton-accion.edit { background:#ffc107; color:black; }
.boton-accion:hover { opacity:0.8; }

#formulario { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin:15px;}
input { padding:8px; width:120px; border-radius: 8px; border: 1px solid #4f545c; background: #25272a; color: white; }
#formulario button { background:#28a745; color:white; padding:8px 15px; border:none; border-radius:8px; cursor:pointer; font-weight: bold; transition: background 0.3s;}
#formulario button:hover { background:#218838;}

#toast { visibility:hidden; min-width:200px; background:#28a745; color:#fff; text-align:center; border-radius:8px; padding:12px; position:fixed; z-index:1; left:50%; bottom:30px; transform:translateX(-50%); font-size:1em; box-shadow: 0 4px 15px rgba(0,0,0,0.3);}
#toast.show { visibility:visible; animation: fadein 0.3s, fadeout 0.3s 1.7s; }
@keyframes fadein { from {bottom:0;opacity:0;} to {bottom:30px;opacity:1;} }
@keyframes fadeout { from {bottom:30px;opacity:1;} to {bottom:0;opacity:0;} }

.botones-footer {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.boton-volver { flex: 1; padding: 12px; font-size: 1em; font-weight: bold; text-align: center; border-radius: 8px; text-decoration: none; transition: opacity 0.3s; background: linear-gradient(45deg, #050a19, #002244); color: white; border: 1px solid #004466; }
.boton-volver:hover { opacity: 0.9; }
.boton-volver i { margin-right: 8px; }

#grafica-container {
  width:95%;
  max-width:600px;
  margin:25px auto;
  background:#2c2f33;
  padding:10px;
  border-radius:8px;
  max-height: 250px; /* Limita la altura de la gr√°fica */
  box-shadow:0 0 5px rgba(0,0,0,0.1);
  text-align:center;
}
#grafica-container button { margin-bottom:10px; }

@media (max-width: 480px) {
  table { font-size: 0.8em; }
  th, td { padding:3px 4px; }
  button.boton-eliminar { padding:2px 5px; font-size:0.75em; }
}
.btn-filtro {
  background: linear-gradient(45deg, #050a19, #002244);
  color: white;
  padding: 6px 12px;
  border: 1px solid #004466;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9em;
  font-weight: bold;
  transition: opacity 0.3s;
}

td.max-valor {
  background: #ffc107; /* amarillo brillante */
  color: black;
  font-weight: bold;
}
#user-header { background: #343a40; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
#user-greeting { font-weight: bold; }
#logout-btn { background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; transition: opacity 0.3s; }
#logout-btn:hover { opacity: 0.8; }
</style>
</head>
<body>
<div class="header-container">
  <div id="user-header">
    <span id="user-greeting"></span>
    <button id="logout-btn">Cerrar Sesi√≥n</button>
  </div>
</div>

<div class="main-container">
  <h1 id="tituloPrincipal">Ejercicio</h1>
  <div id="fecha"></div>
  <div id="tituloEjercicio" style="color: #00c3ff;"></div>
  <div id="videoEjercicio"></div>

  <table>
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
    <tfoot id="tfoot"></tfoot>
  </table>

  <!-- Gr√°fica con bot√≥n -->
  <div id="grafica-container" style="background: #3a3f44;">
    <button id="toggleVista" class="btn-filtro" onclick="alternarVista()">üìà Hist√≥rico</button>
    <canvas id="graficaProgreso" style="margin-top:10px;"></canvas>
  </div>

  <div id="formulario">
    <input type="number" id="peso" placeholder="Peso (kg)">
    <input type="number" id="reps" placeholder="Repeticiones">
    <button onclick="guardarDatos()">Guardar</button>
  </div>

  <div class="botones-footer">
    <a id="volverEjercicios" class="boton-volver ejercicios" href="#"><i>‚Ü©Ô∏è</i> Volver a Ejercicios</a>
    <a id="volverRutinas" class="boton-volver rutinas" href="#"><i>üè†</i> Volver a Rutinas</a>
  </div>
</div>

<div id="toast">‚úÖ Datos guardados</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 

<script type="module">
  import { db, auth } from './firebase-config.js';
  import { doc, getDoc, setDoc, getDocs, collection, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";

  onAuthStateChanged(auth, (user) => {
    if (user) {
      const greeting = document.getElementById('user-greeting');
      if (greeting) {
        greeting.textContent = `Hola, ${user.displayName || user.email}`;
      }
      document.getElementById('logout-btn').addEventListener('click', () => {
        signOut(auth).then(() => window.location.href = 'index.html');
      });
      initializeApp(user); // Pasamos el objeto user completo
    } else {
      window.location.href = 'index.html';
    }
  });
async function initializeApp(user) {
(async function() { // IIFE as√≠ncrona
const userId = user.uid;

const params = new URLSearchParams(window.location.search);
const fecha = params.get('fecha');
const rutinaId = params.get('rutinaId');
const ejercicioId = params.get('ejercicioId');

// Leemos la configuraci√≥n de rutinas del usuario desde Firestore
const userConfigRef = doc(db, "users", userId, "config", "routines");
const docSnap = await getDoc(userConfigRef);
const userRoutines = docSnap.exists() ? docSnap.data().routines : [];

const rutina = userRoutines.find(r => r.id === rutinaId);
const ejercicio = rutina ? rutina.ejercicios.find(e => e.id === ejercicioId) : null;

if (!rutina || !ejercicio) {
  document.body.innerHTML = "<h1>Error: Ejercicio no encontrado</h1>";
  return;
}

const ejercicioNombre = ejercicio.nombre;
const videoUrl = ejercicio.video;

document.getElementById('fecha').textContent = fecha.split('-').reverse().join('-');
document.getElementById('tituloPrincipal').textContent = rutina.titulo;
document.getElementById('tituloEjercicio').textContent = ejercicioNombre;
document.getElementById('volverEjercicios').href = `ejercicios.html?fecha=${fecha}&rutinaId=${rutinaId}`;
document.getElementById('volverRutinas').href = `rutinas.html?fecha=${fecha}`;

if (videoUrl) {
  let embedHtml = '';
  if (videoUrl.includes('youtube.com/watch')) {
    const videoId = new URL(videoUrl).searchParams.get('v');
    embedHtml = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
  } else if (videoUrl.includes('youtube.com/shorts/')) {
    const videoId = videoUrl.split('/shorts/')[1];
    embedHtml = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
  } else {
    embedHtml = `<a href="${videoUrl}" target="_blank">‚ñ∂ Ver v√≠deo del ejercicio</a>`;
  }
  document.getElementById('videoEjercicio').innerHTML = embedHtml;
}

const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const tfoot = document.getElementById('tfoot');

thead.innerHTML = `<tr><th>Fecha</th><th>Peso (kg)</th><th>Repeticiones</th><th>Acciones</th></tr>`;

// Construimos registros desde Firestore
let registros = [];
const querySnapshot = await getDocs(collection(db, "users", userId, "registros"));
const data = {};
querySnapshot.forEach(doc => {
    data[doc.id] = doc.data();
});
for (const f in data) { // f es la fecha (ID del documento)
  const ejer = data[f]?.[rutinaId]?.[ejercicioId]; // Usamos IDs
  if (Array.isArray(ejer)) {
    ejer.forEach((r, i) => registros.push({ fecha: f, peso: r.peso, reps: r.reps, index: i }));
  }
}
registros.sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));

// Funci√≥n para generar la tabla
function actualizarTabla() {
  if (!registros.length) {
    tbody.innerHTML = `<tr><td colspan="4">No hay datos guardados a√∫n</td></tr>`;
    tfoot.innerHTML = '';
  } else {
  // Calcular m√°ximos
const maxPeso = Math.max(...registros.map(r => r.peso));
const maxReps = Math.max(...registros.map(r => r.reps));

// Pintar filas
tbody.innerHTML = registros.map((r, i) => `
  <tr data-fecha="${r.fecha}" data-idx="${r.index}">
    <td contenteditable="true" class="edit-fecha">${r.fecha.split('-').reverse().join('-')}</td>
    <td contenteditable="true" class="edit-peso ${r.peso === maxPeso ? 'max-valor' : ''}">${r.peso}</td>
    <td contenteditable="true" class="edit-reps ${r.reps === maxReps ? 'max-valor' : ''}">${r.reps}</td>
    <td>
      <button class="boton-accion edit" title="Editar registro" onclick="editarFila(this)">‚úèÔ∏è</button>
      <button class="boton-accion" title="Eliminar registro" onclick="eliminarFila('${r.fecha}', ${r.index})">üóëÔ∏è</button>
    </td>
  </tr>
`).join('');

    actualizarResumen();
  }
}

// Funci√≥n para resumen
function actualizarResumen(){
  if (!registros.length) return;
  const dias = registros.length;
  const mediaPeso = (registros.reduce((a,b)=>a+b.peso,0)/dias).toFixed(2);
  const mediaReps = (registros.reduce((a,b)=>a+b.reps,0)/dias).toFixed(2);
  tfoot.innerHTML = `<tr><td>${dias} Series</td><td>${mediaPeso}</td><td>${mediaReps}</td><td></td></tr>`;
}

// Inicializamos tabla
actualizarTabla();

// Funciones para guardar, editar y eliminar
async function guardarDatos(){
  const peso = parseFloat(document.getElementById('peso').value) || 0;
  const reps = parseInt(document.getElementById('reps').value) || 0;

  const docRef = doc(db, "users", userId, "registros", fecha);
  const docSnap = await getDoc(docRef);

  if (docSnap.exists()) {
    const datosActuales = docSnap.data();
    const registrosEjercicio = datosActuales[rutinaId]?.[ejercicioId] || [];
    registrosEjercicio.push({ peso, reps }); // Guardamos el nuevo registro
    await updateDoc(docRef, {
      [`${rutinaId}.${ejercicioId}`]: registrosEjercicio
    });
  } else {
    const nuevoDato = {
      [rutinaId]: {
        [ejercicioId]: [{ peso, reps }]
      }
    };
    await setDoc(docRef, nuevoDato);
  }

  mostrarToast("‚úÖ Datos guardados");
  setTimeout(()=> location.reload(),500);
}

async function eliminarFila(f, idx){
  if (!confirm("¬øEliminar este registro?")) return;
  const docRef = doc(db, "users", userId, "registros", f);
  const docSnap = await getDoc(docRef);
  if (!docSnap.exists()) return;

  const datosActuales = docSnap.data();
  const registrosEjercicio = datosActuales[rutinaId]?.[ejercicioId] || [];
  registrosEjercicio.splice(idx, 1);

  // Creamos el objeto de actualizaci√≥n
  const updateData = {};
  if (registrosEjercicio.length === 0) {
    // Si no quedan registros para este ejercicio, eliminamos el campo del ejercicio
    updateData[`${rutinaId}.${ejercicioId}`] = deleteField();
  } else {
    // Si quedan, actualizamos el array
    updateData[`${rutinaId}.${ejercicioId}`] = registrosEjercicio;
  }
  await updateDoc(docRef, updateData);
  location.reload();
}

async function editarFila(btn){
  const fila = btn.closest('tr');
  const fOriginal = fila.dataset.fecha;
  const idx = parseInt(fila.dataset.idx);
  const nuevaFecha = fila.querySelector('.edit-fecha').textContent.split('-').reverse().join('-');
  const nuevoPeso = parseFloat(fila.querySelector('.edit-peso').textContent);
  const nuevasReps = parseInt(fila.querySelector('.edit-reps').textContent);

  // Elimina el registro antiguo
  const docRefOriginal = doc(db, "users", userId, "registros", fOriginal);
  const docSnapOriginal = await getDoc(docRefOriginal);
  if (docSnapOriginal.exists()) {
    const datosOriginales = docSnapOriginal.data();
    const registrosOriginales = datosOriginales[rutinaId]?.[ejercicioId] || [];
    registrosOriginales.splice(idx, 1);
    await updateDoc(docRefOriginal, { [`${rutinaId}.${ejercicioId}`]: registrosOriginales.length > 0 ? registrosOriginales : deleteField() });
  }

  // Guarda el nuevo registro (simulando un guardado normal)
  const docRefNuevo = doc(db, "users", userId, "registros", nuevaFecha);
  const docSnapNuevo = await getDoc(docRefNuevo);
  const datosNuevos = docSnapNuevo.exists() ? docSnapNuevo.data() : {};
  const registrosNuevos = datosNuevos[rutinaId]?.[ejercicioId] || [];
  registrosNuevos.push({ peso: nuevoPeso, reps: nuevasReps });

  await setDoc(docRefNuevo, { ...datosNuevos, [rutinaId]: { ...datosNuevos[rutinaId], [ejercicioId]: registrosNuevos } }, { merge: true });

  mostrarToast("‚úèÔ∏è Cambios guardados");
  setTimeout(()=> location.reload(),500);
}

function mostrarToast(text){
  const toast = document.getElementById("toast");
  toast.textContent = text;
  toast.className = "show";
  setTimeout(()=> toast.className = toast.className.replace("show",""),2000);
}

// Exponer funciones al scope global para los onclick
window.guardarDatos = guardarDatos;
window.eliminarFila = eliminarFila;
window.editarFila = editarFila;

// ===================== Gr√°fica =====================
let vistaActual = '2m';
let grafica = null;

function alternarVista() {
  vistaActual = vistaActual === '2m' ? 'all' : '2m';
  document.getElementById('toggleVista').textContent = 
    vistaActual === '2m' ? 'üìà Hist√≥rico' : 'üìÖ Dos √∫ltimos meses';
  generarGrafica();
}
window.alternarVista = alternarVista; // Hacemos la funci√≥n accesible globalmente

function generarGrafica() {
  const ctx = document.getElementById('graficaProgreso');
  if (!ctx || !registros.length) return;

  let registrosFiltrados = [...registros];
  if (vistaActual === '2m') {
    const haceDosMeses = new Date();
    haceDosMeses.setMonth(haceDosMeses.getMonth() - 2);
    registrosFiltrados = registros.filter(r => new Date(r.fecha) >= haceDosMeses);
  }

  const etiquetas = registrosFiltrados.map(r => r.fecha.split('-').reverse().join('-'));
  const pesos = registrosFiltrados.map(r => r.peso);
  const reps = registrosFiltrados.map(r => r.reps);

  if (grafica) grafica.destroy();

  grafica = new Chart(ctx, {
    type: 'line',
    data: {
      labels: etiquetas,
      datasets: [
        { label: 'Peso (kg)', data: pesos, borderColor: 'blue', tension: 0.2, fill: false },
        { label: 'Repeticiones', data: reps, borderColor: 'orange', tension: 0.2, fill: false }
      ]
    },
    options: { 
      responsive: true, 
      scales: { 
        y: { 
          beginAtZero: true, 
          ticks: { color: 'white', maxTicksLimit: 6 }, /* Menos saltos en la escala */
          grid: { color: 'rgba(255,255,255,0.1)' } 
        },
        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
      },
      plugins: { legend: { labels: { color: 'white' } } }
    }
  });
}

// Inicializamos gr√°fica
generarGrafica();
})();
} 
</script>

</body>
</html>
