<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estad√≠sticas</title>
<style>
  /* ESTILOS GENERALES Y CONTENEDORES */
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a1d; color: #f1f1f1; margin: 0; padding: 0; }
  .header-container { background: #2c2f33; padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  #user-header { max-width: 600px; margin: 0 auto; background: transparent; }
  .main-container { max-width: 600px; margin: 25px auto; background: #2c2f33; padding: 20px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
  h1 { color: #0095ff; border-bottom: 2px solid #4f545c; padding-bottom: 10px; margin-top: 0; text-align: center; }
  /* FIN DE ESTILOS GENERALES */

#fecha { font-weight: bold; margin: 10px 0; }
table { margin-top: 20px; width: 100%; border-collapse: collapse; table-layout: fixed; background: #3a3f44; border-radius: 8px; overflow: hidden;}
th, td { padding: 12px; text-align: center; font-size: 0.9em; word-wrap: break-word; border-bottom: 1px solid #4f545c;}
th { background: #007bff; color: white; font-weight: bold; }
tbody tr:last-child td { border-bottom: none; }
tbody tr:hover { background-color: #4f545c; }

.botones { display: flex; justify-content: center; gap: 20px; margin: 20px; flex-wrap: wrap; }
.boton {
  background: linear-gradient(45deg, #050a19, #002244);
  color: white;
  padding: 10px 16px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: bold;
  transition: opacity 0.2s;
  border: 1px solid #004466;
}
.boton:hover { opacity: 0.9; }

.modo-tiempo { margin: 20px auto 40px; background: #3a3f44; padding: 20px; border-radius: 10px; display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap; }
.modo-tiempo select, .modo-tiempo input { padding: 8px; border-radius: 8px; border: 1px solid #4f545c; background: #25272a; color: white; }

footer { text-align: center; padding: 15px; background: #2c2f33; color: #aaa; margin-top: 20px; }
.tabla-contenedor { max-height: 300px; overflow-y: auto; margin: 0 auto; width: 100%; border-radius: 10px; }
#filtros input { padding: 5px; }

#user-header { background: #343a40; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
#user-greeting { font-weight: bold; }
#logout-btn { background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; transition: opacity 0.3s; }
#logout-btn:hover { opacity: 0.8; }

#graficaBarrasContainer {
  margin-top: 30px;
  padding: 15px;
}
</style>
</head>
<body>
<div class="header-container">
  <div id="user-header">
    <span id="user-greeting"></span>
    <button id="logout-btn">Cerrar Sesi√≥n</button>
  </div>
</div>

<div class="main-container">
  <h1>üìä Estad√≠sticas</h1>
  <div id="fecha"></div>
  <div class="botones">
    <a class="boton" id="volverRutinas">üèãÔ∏è Ir a Rutinas</a>
    <a class="boton" href="controlgym.html">üìÖ Ir al Calendario</a>
  </div>
  <div class="modo-tiempo">
    <label>Ver estad√≠sticas por:</label>
    <select id="modo">
      <option value="mensual" selected>Mensual</option> <!-- Por defecto mensual -->
      <option value="semanal">Semanal</option>
      <option value="diario">Diario</option>
      <option value="rango">Rango</option>
    </select>
    <div id="filtros" style="display:flex; gap:5px; align-items:center;"></div>
  </div>

  <div id="resumen-tiempo" style="text-align: center; margin: 20px 0; font-size: 1.1em;">
    <h3 style="color: #0095ff; margin-bottom: 5px;">Tiempo Total de Entrenamiento</h3>
    <span id="tiempo-total-display" style="font-weight: bold; color: #ffc107;">Calculando...</span>
  </div>


  <div class="tabla-contenedor">
    <table id="tablaEstadisticas">
      <thead>
        <tr><th>Ejercicio</th><th>Media Peso</th><th>Media Reps</th><th>D√≠as</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  
  <div id="graficaBarrasContainer">
    <h3 style="text-align:center; color: #0095ff;">Media de Peso por Ejercicio</h3>
    <canvas id="graficaBarras"></canvas>
  </div>  
  <div class="botones">
    <button onclick="exportarCSV()" class="boton">üìÑ Exportar a CSV</button>
    <button id="exportExcel" class="boton">üìä Exportar a Excel</button>
  </div>
</div>

<footer>&copy; DasanloSoft, 2025</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script type="module">
  import { db, auth } from './firebase-config.js';
  import { doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";

  let fullData = {}; // Variable global para almacenar todos los datos de Firestore

  onAuthStateChanged(auth, (user) => {
    if (user) {
      const greeting = document.getElementById('user-greeting');
      if (greeting) {
        greeting.textContent = `Hola, ${user.displayName || user.email}`;
      }
      document.getElementById('logout-btn').addEventListener('click', () => {
        signOut(auth).then(() => window.location.href = 'index.html');
      });
      cargarDatosIniciales(user);
    } else {
      window.location.href = 'index.html';
    }
  });
// --- Fecha y enlaces ---
const hoy = new Date();
const yyyy = hoy.getFullYear();
const mm = String(hoy.getMonth()+1).padStart(2,'0');
const dd = String(hoy.getDate()).padStart(2,'0');
const fecha = `${yyyy}-${mm}-${dd}`; // Definimos la fecha aqu√≠
document.getElementById('fecha').textContent = `Fecha: ${dd}-${mm}-${yyyy}`;
document.getElementById('volverRutinas').href = `rutinas.html?fecha=${fecha}`;

// --- Selector de modo ---
const modoSelector = document.getElementById('modo'); 
modoSelector.addEventListener('change', e => {
  const modo = e.target.value;
  const filtros = document.getElementById('filtros');
  filtros.innerHTML = '';
  if(modo==='diario') filtros.innerHTML = `<input type="date" id="fechaDiaria">`;
  else if(modo==='semanal') filtros.innerHTML = `<input type="week" id="semana">`;
  else if(modo==='mensual') filtros.innerHTML = `<input type="month" id="mes" name="mes">`;
  else if(modo==='rango') filtros.innerHTML = `<label>Desde:</label><input type="date" id="inicio"><label>Hasta:</label><input type="date" id="fin">`;

  if (modo === 'mensual') {
    const mesInput = document.getElementById('mes');
    const hoy = new Date();
    mesInput.value = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
  }

  filtros.querySelectorAll('input').forEach(i => i.addEventListener('change', procesarEstadisticas));
  procesarEstadisticas();
});

// Cargar todos los datos de Firestore una sola vez al inicio
async function cargarDatosIniciales(user) {
    const userId = user.uid;
    const querySnapshot = await getDocs(collection(db, "users", userId, "registros"));
    querySnapshot.forEach(doc => { fullData[doc.id] = doc.data(); });

    // Cargamos la configuraci√≥n de rutinas para poder mapear IDs a nombres
    const userConfigRef = doc(db, "users", userId, "config", "routines");
    const docSnap = await getDoc(userConfigRef);
    const userRoutines = docSnap.exists() ? docSnap.data().routines : [];
    window.ejercicioIdToNombre = userRoutines.flatMap(r => r.ejercicios).reduce((acc, ej) => ({ ...acc, [ej.id]: ej.nombre }), {});

    modoSelector.dispatchEvent(new Event('change')); // Iniciar el primer procesamiento
}

// --- Funciones de filtrado ---
function getMondayISO(week,year){
  const simple = new Date(year,0,1+(week-1)*7);
  const dow = simple.getDay();
  const monday = new Date(simple);
  if(dow<=4) monday.setDate(simple.getDate()-simple.getDay()+1);
  else monday.setDate(simple.getDate()+8-simple.getDay());
  monday.setHours(0,0,0,0);
  return monday;
}

function procesarEstadisticas(){
  const modo = document.getElementById('modo').value;
  const data = fullData; // Usar los datos ya cargados
  let fechasFiltradas = Object.keys(data); 

  if(modo==='diario'){
    const f=document.getElementById('fechaDiaria')?.value;
    fechasFiltradas = f?[f]:[];
  } else if(modo==='semanal'){
    const s=document.getElementById('semana')?.value;
    if(s){const [a√±o,sem]=s.split('-W').map(Number); const inicio=getMondayISO(sem,a√±o); const fin=new Date(inicio); fin.setDate(inicio.getDate()+6); fin.setHours(23,59,59,999); fechasFiltradas = fechasFiltradas.filter(f=>{const d=new Date(f); return d>=inicio && d<=fin;});}
  } else if(modo==='mensual'){
    const m=document.getElementById('mes')?.value;
    if(m){const [a√±o,mm]=m.split('-').map(Number); const inicio=new Date(a√±o,mm-1,1); const fin=new Date(a√±o,mm,0,23,59,59,999); fechasFiltradas = fechasFiltradas.filter(f=>{const d=new Date(f); return d>=inicio && d<=fin;});}
  } else if(modo==='rango'){
    const inicioInput=document.getElementById('inicio')?.value;
    const finInput=document.getElementById('fin')?.value;
    if(inicioInput && finInput){const inicio=new Date(inicioInput); const fin=new Date(finInput); fin.setHours(23,59,59,999); fechasFiltradas=fechasFiltradas.filter(f=>{const d=new Date(f); return d>=inicio && d<=fin;});}
  }

  const datosFiltrados={};
  fechasFiltradas.forEach(f=>{if(data[f]) datosFiltrados[f]=data[f];});
  generarEstadisticas(datosFiltrados);
}

function formatTotalTime(totalSeconds) {
  if (totalSeconds === 0) return "0 segundos";
  const h = Math.floor(totalSeconds / 3600);
  const m = Math.floor((totalSeconds % 3600) / 60);
  const s = totalSeconds % 60;
  let parts = [];
  if (h > 0) parts.push(`${h}h`);
  if (m > 0) parts.push(`${m}m`);
  if (s > 0) parts.push(`${s}s`);
  return parts.join(' ');
}

let graficaBarrasChart = null; // Variable para la instancia del gr√°fico

// --- Genera tabla ---
function generarEstadisticas(data){
  const tbody = document.querySelector('#tablaEstadisticas tbody');
  tbody.innerHTML='';
  const resumen={};
  Object.entries(data).forEach(([fecha,rutinas])=>{
    Object.values(rutinas).forEach(rutina => {
      Object.entries(rutina).forEach(([ejercicioId, registros]) => {
        if(!Array.isArray(registros)) return;
        if(!resumen[ejercicioId]) resumen[ejercicioId]={pesos:[], reps:[], dias:new Set()};
        registros.forEach(r=>{if(typeof r.peso==='number') resumen[ejercicioId].pesos.push(r.peso); if(typeof r.reps==='number') resumen[ejercicioId].reps.push(r.reps); resumen[ejercicioId].dias.add(fecha);});
      });
    });
  });

  // Calcular y mostrar tiempo total
  const tiempoTotalSegundos = Object.values(data).reduce((acc, dia) => acc + (dia.tiempoTotal || 0), 0);
  document.getElementById('tiempo-total-display').textContent = formatTotalTime(tiempoTotalSegundos);

  if(Object.keys(resumen).length===0){
    tbody.innerHTML='<tr><td colspan="4">No hay datos disponibles para las fechas seleccionadas</td></tr>';
    return;
  }

  let maxPeso=0, maxReps=0, maxDias=0;
  const filas=[];

  Object.entries(resumen).forEach(([ejercicioId, datos])=>{
    const nombreEjercicio = window.ejercicioIdToNombre[ejercicioId] || ejercicioId; // Muestra el nombre si lo encuentra
    const mediaPeso=(datos.pesos.reduce((a,b)=>a+b,0)/datos.pesos.length).toFixed(2);
    const mediaReps=(datos.reps.reduce((a,b)=>a+b,0)/datos.reps.length).toFixed(0);
    const dias=datos.dias.size;
    filas.push({ejercicio: nombreEjercicio, mediaPeso:parseFloat(mediaPeso), mediaReps:parseInt(mediaReps), dias});
    if(parseFloat(mediaPeso)>maxPeso) maxPeso=parseFloat(mediaPeso);
    if(parseInt(mediaReps)>maxReps) maxReps=parseInt(mediaReps);
    if(dias>maxDias) maxDias=dias;
  });

  let pesoMarcado=false, repsMarcado=false, diasMarcado=false;
  filas.forEach(f=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${f.ejercicio}</td>
      <td style="background:${(!pesoMarcado && f.mediaPeso===maxPeso)?'#28a745':''}; color:${(!pesoMarcado && f.mediaPeso===maxPeso)?'white':''};">${f.mediaPeso}</td>
      <td style="background:${(!repsMarcado && f.mediaReps===maxReps)?'#ffc107':''}; color:${(!repsMarcado && f.mediaReps===maxReps)?'black':''};">${f.mediaReps}</td>
      <td style="background:${(!diasMarcado && f.dias===maxDias)?'#17a2b8':''}; color:${(!diasMarcado && f.dias===maxDias)?'white':''};">${f.dias}</td>`;
    if(!pesoMarcado && f.mediaPeso===maxPeso) pesoMarcado=true;
    if(!repsMarcado && f.mediaReps===maxReps) repsMarcado=true;
    if(!diasMarcado && f.dias===maxDias) diasMarcado=true;
    tbody.appendChild(tr);
  });

  // Generar la gr√°fica de barras
  generarGraficaBarras(filas);
}

function generarGraficaBarras(filas) {
  const ctx = document.getElementById('graficaBarras');
  if (!ctx) return;

  if (graficaBarrasChart) {
    graficaBarrasChart.destroy();
  }

  const etiquetas = filas.map(f => f.ejercicio);
  const datosPeso = filas.map(f => f.mediaPeso);

  graficaBarrasChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: etiquetas,
      datasets: [{
        label: 'Media de Peso (kg)',
        data: datosPeso,
        backgroundColor: 'rgba(0, 149, 255, 0.6)',
        borderColor: 'rgba(0, 149, 255, 1)',
        borderWidth: 1,
        barPercentage: 0.5 // Barras m√°s finas
      }]
    },
    options: {
      indexAxis: 'y', // Eje Y para los ejercicios, mejor para nombres largos
      responsive: true,
      scales: {
        x: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
        y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
      },
      plugins: { legend: { display: false } }
    }
  });
}

// --- Exportar CSV ---
function exportarCSV(){
  const tabla=document.getElementById('tablaEstadisticas');
  const filas=tabla.querySelectorAll('tr');
  const csv=[];
  filas.forEach(fila=>{
    const celdas=fila.querySelectorAll('td, th');
    csv.push(Array.from(celdas).map(c=>`"${c.textContent}"`).join(','));
  });
  const blob=new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8;'});
  const enlace=document.createElement('a'); enlace.href=URL.createObjectURL(blob); enlace.download=`estadisticas_${fecha}.csv`; enlace.click();
}

// --- Exportar Excel ---
document.getElementById('exportExcel').addEventListener('click',()=>{
  const tabla=document.getElementById('tablaEstadisticas');
  if(!tabla) return alert("No hay tabla para exportar");
  const wb=XLSX.utils.table_to_book(tabla,{sheet:"Estad√≠sticas",raw:true});
  XLSX.writeFile(wb,`Estadisticas_${fecha}.xlsx`);
});

window.exportarCSV = exportarCSV; // Exponer al scope global
</script>
</body>
</html>
