<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estad√≠sticas</title>
<style>
body { font-family: Arial; background: #f4f4f4; margin: 0; padding: 0; text-align: center; }
h1 { color: #007bff; margin-top: 20px; }
#fecha { font-weight: bold; margin: 10px 0; }
table { margin-top: 0; width: 100%; border-collapse: collapse; table-layout: fixed; }
th, td { padding: 6px; text-align: center; font-size: 0.9em; word-wrap: break-word; }
th { background: #007bff; color: white; }
.botones { display: flex; justify-content: center; gap: 20px; margin: 20px; flex-wrap: wrap; }
.boton { background: linear-gradient(45deg, #28a745, #004d4d); color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: bold; transition: transform 0.2s; }
.boton:hover { transform: scale(1.05); }
.modo-tiempo { margin: 20px auto 40px; background: rgba(255,255,255,0.9); color: black; padding: 20px; border-radius: 10px; max-width: 600px; display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap; }
.modo-tiempo select, .modo-tiempo input { padding: 6px; border-radius: 6px; border: 1px solid #ccc; }
#botonEstadisticas { display: none; }
footer { background: rgba(0,0,0,0.6); padding: 10px; font-size: 0.9em; position: fixed; bottom: 0; width: 100%; }
.tabla-contenedor { max-height: 300px; overflow-y: auto; margin: 0 auto; width: 90%; max-width: 600px; background: rgba(255,255,255,0.95); border-radius: 10px; }
#filtros input { padding: 5px; }
#user-header { background: #343a40; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
#user-greeting { font-weight: bold; }
#logout-btn { background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
#logout-btn:hover { background: #c82333; }
</style>
</head>
<body>

<div id="user-header">
  <span id="user-greeting"></span>
  <button id="logout-btn">Cerrar Sesi√≥n</button>
</div>

<h1>üìä Estad√≠sticas</h1>
<div id="fecha"></div>

<div class="botones">
  <a class="boton" id="volverRutinas">üèãÔ∏è Ir a Rutinas</a>
  <a class="boton" href="controlgym.html">üìÖ Ir al Calendario</a>
</div>

<div class="modo-tiempo">
  <label>Ver estad√≠sticas por:</label>
  <select id="modo">
    <option value="diario">Diario</option>
    <option value="semanal">Semanal</option>
    <option value="mensual">Mensual</option>
    <option value="rango">Rango</option>
  </select>
  <div id="filtros" style="display:flex; gap:5px; align-items:center;"></div>
</div>

<div class="tabla-contenedor">
  <table id="tablaEstadisticas">
    <thead>
      <tr><th>Ejercicio</th><th>Media Peso</th><th>Media Reps</th><th>D√≠as</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<button onclick="exportarCSV()">Exportar a CSV</button>
<button id="exportExcel" style="margin:15px;">üì• Exportar a Excel</button>

<footer>Copyright DasanloSoft, 2025</footer>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script type="module">
  import { db, auth } from './firebase-config.js';
  import { collection, getDocs } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";

  let userId = null;
  let fullData = {}; // Variable global para almacenar todos los datos de Firestore

  onAuthStateChanged(auth, (user) => {
    if (user) {
      userId = user.uid;
      const greeting = document.getElementById('user-greeting');
      if (greeting) {
        greeting.textContent = `Hola, ${user.displayName || user.email}`;
      }
      document.getElementById('logout-btn').addEventListener('click', () => {
        signOut(auth).then(() => window.location.href = 'index.html');
      });
      cargarDatosIniciales();
    } else {
      window.location.href = 'index.html';
    }
  });
// --- Fecha y enlaces ---
const hoy = new Date();
const yyyy = hoy.getFullYear();
const mm = String(hoy.getMonth()+1).padStart(2,'0');
const dd = String(hoy.getDate()).padStart(2,'0');
const fecha = `${yyyy}-${mm}-${dd}`;
document.getElementById('fecha').textContent = `Fecha: ${dd}-${mm}-${yyyy}`;
document.getElementById('volverRutinas').href = `rutinas.html?fecha=${fecha}`;

// --- Selector de modo ---
const modoSelector = document.getElementById('modo'); 
modoSelector.addEventListener('change', e => {
  const modo = e.target.value;
  const filtros = document.getElementById('filtros');
  filtros.innerHTML = '';
  if(modo==='diario') filtros.innerHTML = `<input type="date" id="fechaDiaria">`;
  else if(modo==='semanal') filtros.innerHTML = `<input type="week" id="semana">`;
  else if(modo==='mensual') filtros.innerHTML = `<input type="month" id="mes">`;
  else if(modo==='rango') filtros.innerHTML = `<label>Desde:</label><input type="date" id="inicio"><label>Hasta:</label><input type="date" id="fin">`;

  filtros.querySelectorAll('input').forEach(i => i.addEventListener('change', procesarEstadisticas));
  procesarEstadisticas();
});

// Cargar todos los datos de Firestore una sola vez al inicio
async function cargarDatosIniciales() {
    const querySnapshot = await getDocs(collection(db, "users", userId, "registros"));
    querySnapshot.forEach(doc => { fullData[doc.id] = doc.data(); });
    modoSelector.dispatchEvent(new Event('change')); // Iniciar el primer procesamiento
}

// --- Funciones de filtrado ---
function getMondayISO(week,year){
  const simple = new Date(year,0,1+(week-1)*7);
  const dow = simple.getDay();
  const monday = new Date(simple);
  if(dow<=4) monday.setDate(simple.getDate()-simple.getDay()+1);
  else monday.setDate(simple.getDate()+8-simple.getDay());
  monday.setHours(0,0,0,0);
  return monday;
}

function procesarEstadisticas(){
  const modo = document.getElementById('modo').value;
  const data = fullData; // Usar los datos ya cargados
  let fechasFiltradas = Object.keys(data); 

  if(modo==='diario'){
    const f=document.getElementById('fechaDiaria')?.value;
    fechasFiltradas = f?[f]:[];
  } else if(modo==='semanal'){
    const s=document.getElementById('semana')?.value;
    if(s){const [a√±o,sem]=s.split('-W').map(Number); const inicio=getMondayISO(sem,a√±o); const fin=new Date(inicio); fin.setDate(inicio.getDate()+6); fin.setHours(23,59,59,999); fechasFiltradas = fechasFiltradas.filter(f=>{const d=new Date(f); return d>=inicio && d<=fin;});}
  } else if(modo==='mensual'){
    const m=document.getElementById('mes')?.value;
    if(m){const [a√±o,mm]=m.split('-').map(Number); const inicio=new Date(a√±o,mm-1,1); const fin=new Date(a√±o,mm,0,23,59,59,999); fechasFiltradas = fechasFiltradas.filter(f=>{const d=new Date(f); return d>=inicio && d<=fin;});}
  } else if(modo==='rango'){
    const inicioInput=document.getElementById('inicio')?.value;
    const finInput=document.getElementById('fin')?.value;
    if(inicioInput && finInput){const inicio=new Date(inicioInput); const fin=new Date(finInput); fin.setHours(23,59,59,999); fechasFiltradas=fechasFiltradas.filter(f=>{const d=new Date(f); return d>=inicio && d<=fin;});}
  }

  const datosFiltrados={};
  fechasFiltradas.forEach(f=>{if(data[f]) datosFiltrados[f]=data[f];});
  generarEstadisticas(datosFiltrados);
}

// --- Genera tabla ---
function generarEstadisticas(data){
  const tbody = document.querySelector('#tablaEstadisticas tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const resumen={};
  Object.entries(data).forEach(([fecha,rutinas])=>{
    Object.values(rutinas).forEach(rutina=>{
      Object.entries(rutina).forEach(([ejercicio,registros])=>{
        if(!Array.isArray(registros)) return;
        if(!resumen[ejercicio]) resumen[ejercicio]={pesos:[], reps:[], dias:new Set()};
        registros.forEach(r=>{if(typeof r.peso==='number') resumen[ejercicio].pesos.push(r.peso); if(typeof r.reps==='number') resumen[ejercicio].reps.push(r.reps); resumen[ejercicio].dias.add(fecha);});
      });
    });
  });

  if(Object.keys(resumen).length===0){tbody.innerHTML='<tr><td colspan="4">No hay datos disponibles para las fechas seleccionadas</td></tr>'; return;}

  let maxPeso=0, maxReps=0, maxDias=0;
  const filas=[];

  Object.entries(resumen).forEach(([ejercicio,datos])=>{
    const mediaPeso=(datos.pesos.reduce((a,b)=>a+b,0)/datos.pesos.length).toFixed(2);
    const mediaReps=(datos.reps.reduce((a,b)=>a+b,0)/datos.reps.length).toFixed(0);
    const dias=datos.dias.size;
    filas.push({ejercicio, mediaPeso:parseFloat(mediaPeso), mediaReps:parseInt(mediaReps), dias});
    if(parseFloat(mediaPeso)>maxPeso) maxPeso=parseFloat(mediaPeso);
    if(parseInt(mediaReps)>maxReps) maxReps=parseInt(mediaReps);
    if(dias>maxDias) maxDias=dias;
  });

  let pesoMarcado=false, repsMarcado=false, diasMarcado=false;
  filas.forEach(f=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${f.ejercicio}</td>
      <td style="background:${(!pesoMarcado && f.mediaPeso===maxPeso)?'#d4edda':''}">${f.mediaPeso}</td>
      <td style="background:${(!repsMarcado && f.mediaReps===maxReps)?'#fff3cd':''}">${f.mediaReps}</td>
      <td style="background:${(!diasMarcado && f.dias===maxDias)?'#cce5ff':''}">${f.dias}</td>`;
    if(!pesoMarcado && f.mediaPeso===maxPeso) pesoMarcado=true;
    if(!repsMarcado && f.mediaReps===maxReps) repsMarcado=true;
    if(!diasMarcado && f.dias===maxDias) diasMarcado=true;
    tbody.appendChild(tr);
  });
}

// --- Exportar CSV ---
function exportarCSV(){
  const tabla=document.getElementById('tablaEstadisticas');
  const filas=tabla.querySelectorAll('tr');
  const csv=[];
  filas.forEach(fila=>{
    const celdas=fila.querySelectorAll('td, th');
    csv.push(Array.from(celdas).map(c=>`"${c.textContent}"`).join(','));
  });
  const blob=new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8;'});
  const enlace=document.createElement('a'); enlace.href=URL.createObjectURL(blob); enlace.download=`estadisticas_${fecha}.csv`; enlace.click();
}

// --- Exportar Excel ---
document.getElementById('exportExcel').addEventListener('click',()=>{
  const tabla=document.getElementById('tablaEstadisticas');
  if(!tabla) return alert("No hay tabla para exportar");
  const wb=XLSX.utils.table_to_book(tabla,{sheet:"Estad√≠sticas",raw:true});
  XLSX.writeFile(wb,`Estadisticas_${fecha}.xlsx`);
});

window.exportarCSV = exportarCSV; // Exponer al scope global
</script>
</body>
</html>
